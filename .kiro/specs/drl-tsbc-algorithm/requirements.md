# DRL-TSBC 算法复现需求文档

## 简介

本项目旨在复现谢嘉昊论文中的DRL-TSBC（基于深度强化学习的双向动态公交时刻表排班算法）。该算法使用深度Q网络（DQN）解决公交时刻表排班问题，通过强化学习动态决策发车时间，并保证上下行方向发车次数平衡。项目需要完整复现论文中的实验结果和可视化图表。

## 术语表

- **DRL-TSBC**: Deep Reinforcement Learning based Two-way Scheduling for Bus Coordination，基于深度强化学习的双向动态公交时刻表排班算法
- **DQN**: Deep Q-Network，深度Q网络
- **MDP**: Markov Decision Process，马尔可夫决策过程
- **仿真环境**: 模拟公交运营的虚拟环境，包括车辆运行、乘客上下车等
- **状态空间**: 描述环境特征的向量，包括时间、客流、车辆信息等
- **动作空间**: 智能体可执行的决策，即上下行是否发车
- **奖励函数**: 评估决策质量的函数，引导算法优化目标
- **经验回放池**: 存储历史经验用于训练的缓冲区
- **目标网络**: DQN中用于稳定训练的辅助网络
- **发车间隔约束**: 公交发车的最小和最大时间间隔限制
- **满载率**: 公交车辆载客量与最大容量的比值
- **滞留乘客**: 因车辆满载无法上车的乘客

## 需求

### 需求 1: 公交仿真环境构建

**用户故事**: 作为算法研究者，我需要一个准确的公交仿真环境，以便模拟真实的公交运营场景并训练强化学习模型。

#### 验收标准

1. WHEN 仿真环境初始化时，THE 仿真环境 SHALL 加载指定线路的站点数量、营运时间和乘客数据
2. WHILE 仿真运行期间，THE 仿真环境 SHALL 以分钟为粒度更新系统状态
3. WHEN 智能体执行发车动作时，THE 仿真环境 SHALL 创建公交车辆实例并模拟其沿线路运行
4. WHEN 公交车到达站点时，THE 仿真环境 SHALL 处理乘客上下车逻辑并更新车辆载客量
5. WHEN 乘客无法上车时，THE 仿真环境 SHALL 记录滞留乘客数量
6. THE 仿真环境 SHALL 计算并返回当前状态向量，包括时间状态、满载率、等待时间、客运容量利用率和发车次数差异
7. THE 仿真环境 SHALL 支持上下行双向独立模拟
8. WHEN 仿真步进时，THE 仿真环境 SHALL 根据动作和当前状态计算奖励值

### 需求 2: 状态空间设计

**用户故事**: 作为算法开发者，我需要准确的状态表示，以便DQN网络能够学习到有效的决策策略。

#### 验收标准

1. THE 状态空间 SHALL 包含全局时间状态，归一化为小时数除以24和分钟数除以60
2. THE 状态空间 SHALL 包含上行方向的满载率，计算为最大断面客流除以车辆最大载客量
3. THE 状态空间 SHALL 包含上行方向的归一化乘客等待时间，使用参数μ=5000进行归一化
4. THE 状态空间 SHALL 包含上行方向的客运容量利用率，计算为实际消耗容量除以提供容量
5. THE 状态空间 SHALL 包含上下行发车次数差异，使用参数δ=200进行归一化
6. THE 状态空间 SHALL 包含下行方向的对应特征，计算方式与上行相同
7. THE 状态空间 SHALL 将所有特征值归一化到0到1的范围内

### 需求 3: 动作空间和约束

**用户故事**: 作为系统设计者，我需要定义清晰的动作空间和发车约束，以便确保生成的时刻表符合实际运营要求。

#### 验收标准

1. THE 动作空间 SHALL 定义为二元组(a_up, a_down)，每个元素取值为0或1
2. WHEN 发车间隔小于最小间隔T_min时，THE 系统 SHALL 强制设置对应方向的动作为0
3. WHEN 发车间隔大于最大间隔T_max时，THE 系统 SHALL 强制设置对应方向的动作为1
4. THE 系统 SHALL 支持四种动作组合：(0,0)、(0,1)、(1,0)、(1,1)

### 需求 4: 奖励函数实现

**用户故事**: 作为算法设计者，我需要精确的奖励函数，以便引导智能体学习优化乘客等待时间和发车平衡的策略。

#### 验收标准

1. THE 奖励函数 SHALL 计算上下行方向的奖励之和作为总奖励
2. WHEN 上行方向不发车时，THE 奖励函数 SHALL 计算奖励为1减去客运容量利用率、等待时间惩罚、滞留乘客惩罚，加上发车次数差异奖励
3. WHEN 上行方向发车时，THE 奖励函数 SHALL 计算奖励为客运容量利用率减去滞留乘客惩罚和发车次数差异惩罚
4. THE 奖励函数 SHALL 使用参数ω作为等待时间惩罚权重，β=0.2作为滞留乘客惩罚权重，ζ=0.002作为发车平衡权重
5. THE 奖励函数 SHALL 对下行方向应用相同的计算逻辑
6. THE 奖励函数 SHALL 支持不同线路使用不同的ω参数值

### 需求 5: DQN网络架构

**用户故事**: 作为深度学习工程师，我需要构建符合论文规格的DQN网络，以便实现有效的函数近似和策略学习。

#### 验收标准

1. THE DQN网络 SHALL 使用12层隐藏层，每层包含500个神经元
2. THE DQN网络 SHALL 使用ReLU作为激活函数
3. THE DQN网络 SHALL 使用正态分布初始化权重
4. THE DQN网络 SHALL 输入状态向量，输出4个Q值对应4种动作
5. THE DQN网络 SHALL 支持GPU加速训练，兼容CUDA 11.8
6. THE 系统 SHALL 维护主网络和目标网络两个独立的网络实例

### 需求 6: DQN训练流程

**用户故事**: 作为机器学习研究者，我需要完整的DQN训练流程，以便训练出能够生成高质量时刻表的模型。

#### 验收标准

1. THE 训练流程 SHALL 使用学习率0.001的Adam优化器
2. THE 训练流程 SHALL 使用大小为3000的经验回放池
3. THE 训练流程 SHALL 使用批次大小64进行训练
4. THE 训练流程 SHALL 使用折扣因子γ=0.4
5. THE 训练流程 SHALL 使用ε=0.1的ε-贪婪策略进行探索
6. THE 训练流程 SHALL 每5步进行一次网络学习
7. THE 训练流程 SHALL 每100次学习更新一次目标网络参数
8. THE 训练流程 SHALL 训练最多50个episode
9. WHEN 经验池未满时，THE 训练流程 SHALL 仅收集经验不进行学习
10. WHEN 经验池已满时，THE 训练流程 SHALL 删除最旧的经验并添加新经验

### 需求 7: 推理和时刻表生成

**用户故事**: 作为系统用户，我需要使用训练好的模型生成公交时刻表，以便应用于实际运营场景。

#### 验收标准

1. THE 推理流程 SHALL 使用训练好的主网络参数选择最优动作
2. THE 推理流程 SHALL 应用发车间隔约束确保时刻表合规
3. THE 推理流程 SHALL 记录所有发车时间点生成时刻表
4. WHEN 上下行发车次数不相等时，THE 推理流程 SHALL 从发车次数较多的方向删除倒数第二次发车
5. WHEN 调整后发车间隔超过T_max时，THE 推理流程 SHALL 向前推迟发车时间直到满足约束
6. THE 推理流程 SHALL 输出最终的上下行时刻表，确保发车次数相等

### 需求 8: 数据加载和预处理

**用户故事**: 作为数据工程师，我需要正确加载和处理乘客数据，以便为仿真环境提供准确的输入。

#### 验收标准

1. THE 数据加载模块 SHALL 读取test_data目录下的CSV格式乘客数据
2. THE 数据加载模块 SHALL 支持加载208和211线路的上下行数据
3. THE 数据加载模块 SHALL 解析乘客到达时间、上车站点、下车站点等信息
4. THE 数据加载模块 SHALL 按时间顺序组织乘客数据
5. THE 数据加载模块 SHALL 验证数据完整性和格式正确性

### 需求 9: 实验结果记录

**用户故事**: 作为实验研究者，我需要记录训练和测试过程中的关键指标，以便分析算法性能和生成可视化图表。

#### 验收标准

1. THE 记录模块 SHALL 在训练期间记录每个episode的平均奖励
2. THE 记录模块 SHALL 在训练期间记录每个episode的上下行发车次数
3. THE 记录模块 SHALL 在测试期间记录生成的时刻表
4. THE 记录模块 SHALL 在测试期间计算乘客平均等待时间
5. THE 记录模块 SHALL 在测试期间统计滞留乘客数量
6. THE 记录模块 SHALL 在测试期间计算每个时间段的客运容量
7. THE 记录模块 SHALL 将所有数据保存为CSV或JSON格式便于后续分析

### 需求 10: 可视化图表生成

**用户故事**: 作为论文作者，我需要生成与论文一致的可视化图表，以便验证算法复现的准确性。

#### 验收标准

1. THE 可视化模块 SHALL 生成训练收敛曲线图，包含平均奖励和上下行发车次数
2. THE 可视化模块 SHALL 生成参数敏感性分析图，展示不同ω值对性能的影响
3. THE 可视化模块 SHALL 生成客流适应性测试图，对比调整前后的客运量
4. THE 可视化模块 SHALL 生成算法对比图，对比DRL-TSBC与人工方案的性能
5. THE 可视化模块 SHALL 生成性能对比表格，包含发车次数、等待时间和滞留乘客数
6. THE 可视化模块 SHALL 支持双Y轴折线图绘制
7. THE 可视化模块 SHALL 使用中文标签和图例
8. THE 可视化模块 SHALL 保存高分辨率图片文件

### 需求 11: 对比实验实现

**用户故事**: 作为算法评估者，我需要实现多种对比实验，以便全面评估DRL-TSBC的性能优势。

#### 验收标准

1. THE 系统 SHALL 支持加载和评估人工方案的时刻表
2. THE 系统 SHALL 支持消融实验，包括设置ζ=0和删除状态特征
3. THE 系统 SHALL 支持客流变化场景测试，包括增加晚高峰客流和提前晚高峰
4. THE 系统 SHALL 支持不同ω参数的敏感性分析实验
5. THE 系统 SHALL 对每种实验场景计算相同的性能指标便于对比

### 需求 12: 可复现性保证

**用户故事**: 作为科研工作者，我需要确保实验结果可复现，以便验证算法的稳定性和可靠性。

#### 验收标准

1. THE 系统 SHALL 支持设置随机种子以确保结果可复现
2. THE 系统 SHALL 使用与论文完全一致的参数配置
3. THE 系统 SHALL 提供配置文件管理所有超参数
4. THE 系统 SHALL 记录实验环境信息，包括Python版本、PyTorch版本和CUDA版本
5. THE 系统 SHALL 支持保存和加载训练好的模型权重

---

**最后更新时间**: 2025年1月
