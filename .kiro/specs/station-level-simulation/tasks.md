# Implementation Plan

- [x] 1. 创建新的数据结构



  - 创建 `src/environment/station_level_simulator.py` 文件
  - 实现 Station 数据类
  - 实现增强版 Passenger 数据类（包含上下车站点）
  - 实现增强版 BusTrip 数据类（包含站点列表和到达时间）
  - 实现增强版 DirectionState 数据类（包含站点列表）


  - _Requirements: 1.1, 2.1, 3.1, 3.2, 3.3_

- [ ] 2. 实现站点配置和数据加载
  - 从真实数据中提取站点列表
  - 创建站点ID到站点对象的映射
  - 实现乘客数据到Passenger对象的转换

  - 实现乘客按到达时间和站点的分组
  - 加载或估算站点间行驶时间数据
  - _Requirements: 3.1, 3.2, 3.3, 6.1, 6.2, 6.3_

- [x] 3. 实现乘客到达站点的逻辑

  - 实现 `_update_passenger_arrivals()` 方法
  - 根据当前时间将乘客添加到对应站点的等待队列
  - 验证乘客正确分配到各站点
  - _Requirements: 2.2, 3.4_

- [x] 4. 实现发车逻辑

  - 重写 `_dispatch_bus()` 方法
  - 创建包含所有站点的BusTrip对象
  - 计算各站点的到达时间（累加行驶时间和停靠时间）
  - 将行程添加到在途列表
  - _Requirements: 1.1, 1.2, 1.3, 6.4_

- [x] 5. 实现站点停靠处理

  - 实现 `_process_station_stop()` 方法
  - 处理乘客下车（移除到达目的地的乘客）
  - 处理乘客上车（从等待队列上车，受容量限制）
  - 计算每个上车乘客的等待时间
  - 累加到总等待时间
  - _Requirements: 1.4, 2.3, 2.4, 3.5, 4.1, 4.2, 5.1, 5.4_


- [ ] 6. 实现公交车状态更新
  - 重写 `_update_buses()` 方法
  - 检查每辆在途公交车是否到达下一个站点
  - 调用站点停靠处理
  - 标记完成的行程
  - 移除已完成的行程


  - _Requirements: 1.2, 1.3, 1.5_

- [ ] 7. 实现等待时间和滞留乘客统计
  - 在乘客上车时计算并累加等待时间
  - 实现平均等待时间计算（总等待时间/总乘客数）


  - 实现滞留乘客统计（服务结束时所有站点的等待乘客）
  - 更新 `get_statistics()` 方法
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.2, 5.3_

- [ ] 8. 保持接口兼容性
  - 确保 `_get_current_state()` 返回10维状态


  - 确保 `step()` 接受 (a_up, a_down) 动作
  - 确保 `get_statistics()` 返回相同格式
  - 确保 `reset()` 正确初始化所有状态
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 9. 创建单元测试


  - 测试站点队列的添加和移除
  - 测试乘客上下车逻辑
  - 测试等待时间计算
  - 测试行程模拟（公交车经过所有站点）
  - 测试数据一致性（乘客数量守恒）
  - _Requirements: 所有_

- [ ] 10. 集成测试和验证
  - 运行完整episode测试
  - 验证等待时间接近论文结果（3.7/3.8分钟）
  - 验证滞留乘客接近论文结果（0人）
  - 验证发车次数保持平衡
  - 对比新旧模拟器的结果差异
  - _Requirements: 所有_

- [ ] 11. 性能优化
  - 分析运行时间瓶颈
  - 优化站点查找（使用字典索引）
  - 优化公交车更新（只更新活跃的车辆）
  - 确保训练速度可接受
  - _Requirements: 所有_

- [ ] 12. 替换旧模拟器并训练
  - 在训练脚本中切换到新模拟器
  - 运行完整训练（500 episodes）
  - 验证结果与论文对比
  - 生成对比报告
  - _Requirements: 所有_
